---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { Card, CardGrid } from '@astrojs/starlight/components';
import { Icon } from 'astro-icon/components';
import tylerImage from '../assets/tyler.png';
import { getCollection } from 'astro:content';
interface BskyPost {
  text: string;
  createdAt: string;
  url: string;
  image?: string;
}

let posts: BskyPost[] = [];
const latestBlog = (await getCollection('blog'))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);

try {
  const res = await fetch(
    'https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=tylerstaut.com&limit=3'
  );
  if (res.ok) {
    const data = await res.json();
    posts = data.feed.map(({ post }: any) => {
      const rkey = post.uri.split('/').pop();
      const image =
        post.embed?.images?.[0]?.thumb ||
        post.embed?.media?.images?.[0]?.thumb;
      return {
        text: post.record.text,
        createdAt: post.record.createdAt,
        url: `https://bsky.app/profile/${post.author.handle}/post/${rkey}`,
        image
      };
    });
  }
} catch (err) {
  console.error('Failed to fetch Bluesky posts', err);
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

const frontmatter = {
  title: 'Tyler Staut',
  description: 'Traveler • Hacker • CTF Junkie',
  template: 'splash',
  hero: {
    title: 'Hey! I\u2019m Tyler',
    tagline: 'Boldly going where no hacker has gone before<br />Probably doing a <a href="https://careerlimitingmaneuver.com" target="_blank" rel="noopener noreferrer">Career Limiting Maneuver</a>',
    image: { file: tylerImage, alt: 'Tyler Staut head-shot' },
    actions: [
      { text: 'Read my Blog', link: '/blog/', icon: 'rss', variant: 'secondary' },
      { text: 'Dive into my Docs', link: '/notes/', icon: 'right-arrow' },
    ]
  }
};
---
<StarlightPage frontmatter={frontmatter} hasSidebar={false}>
  <CardGrid stagger>
    <Card class="flex flex-col" title="About" icon="information" href="/about/">
      I enjoy traveling, gaming, homelabbing, taking part in CTF's and generally working in tech/security.
      <br /><br />
      I am using this to help me on my journey and will include a lot of information I find useful.
      <br /><br />
      Whether you're here for tips on security or just curious about my projects, I hope you'll find something that sparks your interest!
    </Card>

    <Card class="flex flex-col" title="Projects" icon="rocket" href="/projects/">
      A few things I’m building:
      <ul>
        <li>Cloudflare Workers</li>
        <li>Home lab project</li>
        <li>CTF write-ups</li>
        <li>Security tools</li>
        <li>Discord Bot stuff</li>
        <li>And more!</li>
      </ul>
    </Card>

    <Card class="flex flex-col" title="Contact" icon="email">
      <small class="flex items-center gap-2 flex-row whitespace-nowrap w-full" style="display:block;">
        <span style="display:flex;align-items:center;gap:0.75rem;">
          <a href="https://linkedin.com/in/Tyler-Staut" class="inline-flex items-center no-underline" style="color:inherit;" aria-label="LinkedIn">
            <Icon name="simple-icons:linkedin" size="30" style="color:currentColor;" />
          </a>
          <a href="https://github.com/Tyler-Staut" class="inline-flex items-center no-underline" style="color:inherit;" aria-label="GitHub">
            <Icon name="simple-icons:github" size="30" style="color:currentColor;" />
          </a>
          <a href="https://bsky.app/profile/tylerstaut.com" class="inline-flex items-center no-underline" style="color:inherit;" aria-label="Bluesky">
            <Icon name="simple-icons:bluesky" size="30" style="color:currentColor;" />
          </a>
        </span>
      </small>
    </Card>
  </CardGrid>

  <section class="latest-bluesky">
    <h2 style="display: flex; color:inherit; align-items: center; gap: 0.5em; font-size: 1.5rem;">
      <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/bluesky.svg" alt="Bluesky" style="width: 1.5em; height: 1.5em; vertical-align: middle;" />
      <span>From Bluesky</span>
    </h2>
    <p style="color:inherit;" margin-top: 0; margin-bottom: 1rem; font-size: 1rem;">
      A peek at my latest posts on <a href="https://bsky.app/profile/tylerstaut.com" target="_blank" rel="noopener noreferrer" style="color:inherit; text-decoration: underline;">Bluesky</a>.
    </p>
    {posts.length === 0 ? (
      <p>No Bluesky posts yet.</p>
    ) : (
      <ul class="bsky-list">
        {posts.map((post) => (
          <li>
            <a
              class="bsky-card"
              href={post.url}
              target="_blank"
              rel="noopener noreferrer"
              style={post.image ? `--bg-image: url('${post.image}')` : undefined}
            >
              <p>{post.text}</p>
              <time datetime={post.createdAt}>{formatDate(post.createdAt)}</time>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</StarlightPage>

<style>
  .latest-blog,
  .latest-bluesky {
    margin-top: 2rem;
  }

  .post-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .post-list li {
    margin-bottom: 0.5rem;
  }

  .archive-link {
    text-align: right;
  }

  .bsky-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 1rem;
  }

  @media (min-width: 50rem) {
    .bsky-list {
      grid-template-columns: repeat(auto-fill, minmax(16rem, 1fr));
    }
  }

  .bsky-card {
    display: block;
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    min-height: 10rem;
    padding: 1rem;
    color: var(--sl-color-white);
    text-decoration: none;
    background-color: var(--sl-color-gray-6);
    background-image: var(--bg-image);
    background-size: cover;
    background-position: center;
    box-shadow: var(--sl-shadow-sm);
  }

  .bsky-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    pointer-events: none;
  }

  .bsky-card p,
  .bsky-card time {
    position: relative;
    margin: 0;
  }

  .bsky-card time {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
  }
</style>
